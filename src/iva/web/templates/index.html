{% extends "base.html" %}
{% block content %}
  
  <!-- Prominent Demo Callout Box -->
  <div class="mb-6 p-5 rounded-xl bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200">
    <div class="flex items-start gap-3">
      <div class="text-3xl">üëâ</div>
      <div class="flex-1">
        <h3 class="text-lg font-semibold text-slate-900 mb-2">New here? Try a quick demo!</h3>
        <p class="text-slate-700 mb-3">Click one of these examples to see a live analysis (takes ~30-60 seconds):</p>
        <div class="flex flex-wrap gap-2">
          <button type="button" onclick="loadDemo('https://stripe.com', 'Stripe Inc.')" class="px-4 py-2 rounded-lg bg-white border-2 border-blue-300 text-slate-800 font-medium shadow-sm hover:shadow-md hover:border-blue-400 transition-all">
            üöÄ Stripe
          </button>
          <button type="button" onclick="loadDemo('https://plaid.com', 'Plaid Inc.')" class="px-4 py-2 rounded-lg bg-white border-2 border-blue-300 text-slate-800 font-medium shadow-sm hover:shadow-md hover:border-blue-400 transition-all">
            üè¶ Plaid
          </button>
          <button type="button" onclick="loadDemo('https://brex.com', 'Brex Inc.')" class="px-4 py-2 rounded-lg bg-white border-2 border-blue-300 text-slate-800 font-medium shadow-sm hover:shadow-md hover:border-blue-400 transition-all">
            üí≥ Brex
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-8">
    <section>
      <h2 class="text-xl font-semibold text-slate-900 mb-4">Run Truth Meter</h2>
      <form id="truthForm" action="/run" method="post" class="space-y-4" onsubmit="return handleSubmit(event)">
        <div>
          <label class="block text-sm font-medium text-slate-600 mb-1">Company URL</label>
          <input required name="url" id="urlInput" type="url" placeholder="https://example.com" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400/50 bg-white/70"/>
          <p id="urlError" class="text-sm text-red-600 mt-1 hidden"></p>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-600 mb-1">Company Name</label>
          <input required name="company" id="companyInput" type="text" placeholder="Acme Payments Inc." class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400/50 bg-white/70"/>
          <p id="companyError" class="text-sm text-red-600 mt-1 hidden"></p>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-600 mb-1">Jurisdiction</label>
            <select name="jurisdiction" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white/70">
              <option value="US">US</option>
              <option value="CA">CA</option>
              <option value="EU">EU</option>
              <option value="UK">UK</option>
            </select>
          </div>
          <div class="flex items-end gap-4">
            <label class="inline-flex items-center gap-2 text-sm text-slate-700 relative group">
              <input type="checkbox" name="render_js" value="1" class="rounded" /> 
              <span>Render JS</span>
              <span class="cursor-help">‚ÑπÔ∏è</span>
              <div class="hidden group-hover:block absolute bottom-full left-0 mb-2 w-64 p-3 bg-slate-800 text-white text-xs rounded-lg shadow-lg z-10">
                Enable JavaScript rendering for sites that load content dynamically. May increase analysis time.
              </div>
            </label>
            <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input type="checkbox" name="send_to_slack" value="1" class="rounded" /> Send to Slack
            </label>
          </div>
        </div>
        <div class="pt-2 flex gap-3">
          <button type="submit" id="submitBtn" class="btn px-5 py-3 rounded-xl bg-black text-white shadow-sm hover:shadow-lg font-medium">
            Run Truth Meter
          </button>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <p class="text-sm text-slate-700">‚è±Ô∏è <strong>Estimated time:</strong> 30-60 seconds per analysis</p>
          <p class="text-xs text-slate-500 mt-1">Requires configured OPENAI_API_KEY. Slack posting is optional.</p>
        </div>
      </form>
    </section>

    <section>
      <h2 class="text-xl font-semibold text-slate-900 mb-4">About</h2>
      <p class="text-slate-600 leading-relaxed">Iva's Reality Layer turns claims into facts. It extracts licensing, partner-bank, and security assertions from a company's site, checks authoritative sources, reconciles discrepancies, and produces a severity/confidence truth card and memo.</p>
      <ul class="mt-4 space-y-2 text-slate-600 text-sm">
        <li>‚Ä¢ Ingest ‚ûú Extract claims ‚ûú Query sources ‚ûú Reconcile ‚ûú Slack card + Memo</li>
        <li>‚Ä¢ Adapters (MVP): NMLS, FINTRAC, EDGAR, CFPB, Bank partners, Trust center, News (stubs/live mix)</li>
        <li>‚Ä¢ Advisory only ‚Äî not legal advice</li>
      </ul>
    </section>
  </div>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="hidden mt-8 p-8 rounded-xl bg-white border border-slate-200 text-center">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-slate-900 mb-4"></div>
    <h3 class="text-lg font-semibold text-slate-900 mb-2">Analyzing Company Claims...</h3>
    <p class="text-slate-600 mb-2">This may take 30-60 seconds</p>
    <div id="progressMessage" class="text-sm mb-3">
      <p class="text-slate-600">üìä Extracting and analyzing claims...</p>
    </div>
    <div class="text-sm text-slate-500 space-y-1">
      <p>‚úì Fetching website content</p>
      <p>‚úì Extracting claims with AI</p>
      <p>‚úì Querying authoritative sources (NMLS, EDGAR, CFPB...)</p>
      <p>‚úì Reconciling discrepancies</p>
      <p>‚è≥ Generating truth card and memo...</p>
    </div>
  </div>

  {% if error %}
    <div class="mt-8 p-5 rounded-xl bg-red-50 border-2 border-red-300">
      <div class="flex items-start gap-3">
        <div class="text-2xl">‚ö†Ô∏è</div>
        <div class="flex-1">
          <h3 class="text-lg font-semibold text-red-800 mb-2">Analysis Failed</h3>
          <p class="text-red-700 mb-3">{{ error | safe }}</p>
          <button onclick="location.reload()" class="px-4 py-2 rounded-lg bg-white border border-red-300 text-red-700 font-medium hover:bg-red-50">
            Try Again
          </button>
        </div>
      </div>
    </div>
  {% endif %}

  {% if result %}
  <div class="mt-8 grid lg:grid-cols-2 gap-8">
    <div class="glass rounded-2xl p-5 border border-slate-200/70">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div class="text-sm text-slate-500">{{ result.company }}</div>
          <div class="text-lg font-semibold text-slate-900">Truth Card</div>
        </div>
        <div class="text-sm text-slate-500">{{ result.card.severity_summary }} ‚Ä¢ Conf {{ (result.card.overall_confidence*100)|round }}%</div>
      </div>
      <div class="divide-y divide-slate-200">
        {% for d in result.card.discrepancies %}
          <div class="py-4">
            <div class="flex items-center gap-2">
              <div class="text-xl">{{ sev_emoji(d.severity) }}</div>
              <div class="font-medium text-slate-900">{{ d.type }} <span class="text-slate-500 text-xs">(sev {{ d.severity }}, conf {{ (d.confidence*100)|round }}%)</span></div>
            </div>
            <div class="mt-2 text-slate-700 text-sm">Why it matters: {{ d.why_it_matters }}</div>
            <div class="text-slate-600 text-sm">Expected evidence: {{ d.expected_evidence }}</div>
            <ul class="mt-2 text-sm text-slate-700 space-y-1">
              {% for f in d.findings %}
                <li>‚Ä¢ <span class="font-medium">{{ f.key }}</span> = {{ f.value }} <span class="text-slate-500">({{ f.status }})</span></li>
              {% endfor %}
            </ul>
          </div>
        {% else %}
          <div class="py-6 text-slate-500">No discrepancies flagged.</div>
        {% endfor %}
      </div>
    </div>

    <div class="space-y-6">
      <div class="glass rounded-2xl p-5 border border-slate-200/70">
        <div class="flex items-center justify-between mb-3">
          <div class="text-lg font-semibold text-slate-900">Memo HTML</div>
          <button type="button" class="btn px-3 py-1.5 rounded-lg border border-slate-200" data-copy="memoHtml" onclick="copyText('memoHtml')">Copy</button>
        </div>
        <div id="memoHtml" class="prose prose-slate max-w-none">{{ result.memo_html | safe }}</div>
      </div>
      <div class="glass rounded-2xl p-5 border border-slate-200/70">
        <div class="flex items-center justify-between mb-3">
          <div class="text-lg font-semibold text-slate-900">Raw JSON</div>
          <button type="button" class="btn px-3 py-1.5 rounded-lg border border-slate-200" data-copy="cardJson" onclick="copyText('cardJson')">Copy</button>
        </div>
        <pre id="cardJson" class="text-xs bg-white/70 rounded-xl p-3 overflow-auto">{{ result.card_json }}</pre>
      </div>
    </div>
  </div>
  
  <!-- Run Another Analysis Button -->
  <div class="mt-6 text-center">
    <button onclick="location.reload()" class="btn px-6 py-3 rounded-xl bg-slate-700 text-white shadow-sm hover:shadow-lg font-medium">
      üîÑ Run Another Analysis
    </button>
  </div>
  {% endif %}

  <script>
    let progressInterval;
    let progressSeconds = 0;
    
    function loadDemo(url, company) {
      document.querySelector('input[name="url"]').value = url;
      document.querySelector('input[name="company"]').value = company;
      document.querySelector('select[name="jurisdiction"]').value = 'US';
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // Auto-submit after 500ms delay so user sees fields populate
      setTimeout(() => {
        document.getElementById('truthForm').submit();
      }, 500);
    }

    function validateURL(url) {
      try {
        const urlObj = new URL(url);
        if (!urlObj.protocol.match(/^https?:$/)) {
          return 'URL must start with http:// or https://';
        }
        if (!urlObj.hostname || urlObj.hostname.length < 1) {
          return 'Please enter a valid domain name';
        }
        // Removed localhost blocking - recruiters may test internal sites
        return null;
      } catch (e) {
        return 'Please enter a valid URL (e.g., https://example.com)';
      }
    }

    function updateProgressMessage() {
      progressSeconds += 5;
      const messageEl = document.getElementById('progressMessage');
      
      if (progressSeconds >= 90) {
        messageEl.innerHTML = '<p class="text-amber-600 font-semibold">‚è≥ Still analyzing... almost done! This is taking longer than usual.</p>';
      } else if (progressSeconds >= 60) {
        messageEl.innerHTML = '<p class="text-slate-600">‚öôÔ∏è Processing complex claims and cross-referencing sources...</p>';
      } else if (progressSeconds >= 30) {
        messageEl.innerHTML = '<p class="text-slate-600">üîç Querying regulatory databases...</p>';
      } else {
        messageEl.innerHTML = '<p class="text-slate-600">üìä Extracting and analyzing claims...</p>';
      }
    }

    function handleSubmit(event) {
      const urlInput = document.getElementById('urlInput');
      const urlError = document.getElementById('urlError');
      const companyInput = document.getElementById('companyInput');
      const companyError = document.getElementById('companyError');
      const formGrid = document.querySelector('.grid.md\\:grid-cols-2');
      
      // Clear previous errors
      urlError.classList.add('hidden');
      companyError.classList.add('hidden');
      
      let hasError = false;
      
      // Validate URL
      if (!urlInput.value.trim()) {
        urlError.textContent = 'Please enter a company URL';
        urlError.classList.remove('hidden');
        hasError = true;
      } else {
        const validationError = validateURL(urlInput.value);
        if (validationError) {
          urlError.textContent = validationError;
          urlError.classList.remove('hidden');
          hasError = true;
        }
      }
      
      // Validate company name
      if (!companyInput.value.trim()) {
        companyError.textContent = 'Please enter a company name';
        companyError.classList.remove('hidden');
        hasError = true;
      }
      
      if (hasError) {
        event.preventDefault();
        // Ensure form grid stays visible on validation errors
        formGrid.style.display = '';
        return false;
      }
      
      // Hide form and show loading spinner
      document.getElementById('truthForm').style.display = 'none';
      formGrid.style.display = 'none';
      document.getElementById('loadingSpinner').classList.remove('hidden');
      
      // Start progress updates every 5 seconds
      progressSeconds = 0;
      progressInterval = setInterval(updateProgressMessage, 5000);
      
      return true;
    }
    
    // Clean up interval if page unloads
    window.addEventListener('beforeunload', () => {
      if (progressInterval) {
        clearInterval(progressInterval);
      }
    });
  </script>
{% endblock %}
