{% extends "base.html" %}
{% block content %}

<div class="flex items-center justify-between mb-6">
  <div class="text-caption text-dark-400">Ready to scout.</div>
</div>

<div class="grid lg:grid-cols-12 gap-6">
  <section class="lg:col-span-4 space-y-6">
    <div class="surface-elevated rounded-xl p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-caption text-dark-400">SCAN QUEUE</h2>
        <span class="text-xs text-dark-500" id="targetCount">0 Targets</span>
      </div>

      <form id="truthForm" action="/run" method="post" class="space-y-4" onsubmit="return handleSubmit(event)">
        <div>
          <label for="urlInput" class="block text-caption text-dark-400 mb-2">Company URL <span class="text-red-400">*</span></label>
          <input required name="url" id="urlInput" type="url" placeholder="https://example.com"
            aria-describedby="urlError urlHelp" aria-invalid="false" autocomplete="url"
            class="w-full px-4 py-3 rounded-lg bg-dark-800 border border-dark-600 text-dark-100 placeholder-dark-500 font-mono text-sm focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400/20" />
          <p id="urlHelp" class="text-xs text-dark-500 mt-1">Enter the full URL of the company website</p>
          <p id="urlError" class="text-sm text-red-400 mt-2 font-medium hidden" role="alert" aria-live="polite"></p>
        </div>

        <div>
          <label for="companyInput" class="block text-caption text-dark-400 mb-2">Company Name <span class="text-red-400">*</span></label>
          <input required name="company" id="companyInput" type="text" placeholder="Acme Payments Inc."
            aria-describedby="companyError companyHelp" aria-invalid="false" autocomplete="organization"
            class="w-full px-4 py-3 rounded-lg bg-dark-800 border border-dark-600 text-dark-100 placeholder-dark-500 text-sm focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400/20" />
          <p id="companyHelp" class="text-xs text-dark-500 mt-1">Enter the legal or common name</p>
          <p id="companyError" class="text-sm text-red-400 mt-2 font-medium hidden" role="alert" aria-live="polite"></p>
        </div>

        <div>
          <label class="block text-caption text-dark-400 mb-2">
            Stock Ticker <span class="text-dark-500 font-normal text-xs normal-case">(optional)</span>
          </label>
          <input name="ticker" id="tickerInput" type="text" placeholder="AAPL" maxlength="10"
            class="w-full px-4 py-3 rounded-lg bg-dark-800 border border-dark-600 text-dark-100 placeholder-dark-500 font-mono text-sm uppercase focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400/20" />
          <p class="text-xs text-dark-500 mt-1">Enables SEC filings analysis</p>
        </div>

        <div>
          <label for="jurisdictionSelect" class="block text-caption text-dark-400 mb-2">Jurisdiction</label>
          <select id="jurisdictionSelect" name="jurisdiction"
            class="w-full px-4 py-3 rounded-lg bg-dark-800 border border-dark-600 text-dark-100 text-sm cursor-pointer focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400/20">
            <option value="US">üá∫üá∏ United States</option>
            <option value="CA">üá®üá¶ Canada</option>
            <option value="EU">üá™üá∫ European Union</option>
            <option value="UK">üá¨üáß United Kingdom</option>
          </select>
        </div>

        <div class="flex flex-wrap gap-4 pt-2">
          <label class="inline-flex items-center gap-2 text-xs text-dark-300 cursor-pointer group">
            <input type="checkbox" name="render_js" value="1" class="rounded bg-dark-700 border-dark-500 text-cyan-500 focus:ring-cyan-400/20 cursor-pointer" />
            <span>Render JS</span>
            <span class="text-dark-500 group-hover:text-dark-300 transition-colors">‚ÑπÔ∏è</span>
          </label>
          <label class="inline-flex items-center gap-2 text-xs text-dark-300 cursor-pointer">
            <input type="checkbox" name="send_to_slack" value="1" class="rounded bg-dark-700 border-dark-500 text-cyan-500 focus:ring-cyan-400/20 cursor-pointer" />
            <span>Send to Slack</span>
          </label>
        </div>

        <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token is defined else '' }}" />
      </form>

      <div id="urlQueueDisplay" class="mt-4 space-y-1 max-h-32 overflow-y-auto hidden">
      </div>
    </div>

    <div class="surface-elevated rounded-xl p-5">
      <h3 class="text-caption text-dark-400 mb-3">QUICK DEMOS</h3>
      <div class="space-y-2">
        <p class="text-xs text-dark-500 uppercase tracking-wider mb-2">Private Companies</p>
        <div class="grid grid-cols-3 gap-2">
          <button type="button" onclick="loadDemo('https://stripe.com', 'Stripe Inc.', '')"
            class="btn btn-demo btn-sm cyan-theme">
            Stripe
          </button>
          <button type="button" onclick="loadDemo('https://plaid.com', 'Plaid Inc.', '')"
            class="btn btn-demo btn-sm cyan-theme">
            Plaid
          </button>
          <button type="button" onclick="loadDemo('https://squareup.com', 'Square Inc.', 'SQ')"
            class="btn btn-demo btn-sm cyan-theme">
            Square
          </button>
        </div>
        <p class="text-xs text-dark-500 uppercase tracking-wider mt-3 mb-2">Public Companies (SEC)</p>
        <div class="grid grid-cols-3 gap-2">
          <button type="button" onclick="loadDemo('https://www.apple.com', 'Apple Inc.', 'AAPL')"
            class="btn btn-demo btn-sm teal-theme">
            Apple
          </button>
          <button type="button" onclick="loadDemo('https://www.paypal.com', 'PayPal Holdings Inc.', 'PYPL')"
            class="btn btn-demo btn-sm teal-theme">
            PayPal
          </button>
          <button type="button" onclick="loadDemo('https://www.marqeta.com', 'Marqeta Inc.', 'MQ')"
            class="btn btn-demo btn-sm teal-theme">
            Marqeta
          </button>
        </div>
      </div>
    </div>
  </section>

  <section class="lg:col-span-8 space-y-6">
    <div class="grid grid-cols-3 gap-4">
      <div class="stat-card">
        <div class="stat-label">COMPANIES SCANNED</div>
        <div class="stat-value" id="statScanned">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">HIGH SIGNAL</div>
        <div class="stat-value" id="statHighSignal">0</div>
        <div class="stat-sublabel">&gt;80 Score</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">THESIS FIT</div>
        <div class="stat-value" id="statThesisFit">0%</div>
      </div>
    </div>

    <div id="resultsPanel" class="surface-elevated rounded-xl min-h-[400px] flex flex-col">
      <div id="emptyState" class="flex-1 flex flex-col items-center justify-center p-12 text-center">
        <div class="radar-container mb-8 empty-state-icon">
          <div class="radar-ring radar-ring-1"></div>
          <div class="radar-ring radar-ring-2"></div>
          <div class="radar-ring radar-ring-3"></div>
          <div class="radar-sweep"></div>
          <div class="radar-center"></div>
        </div>
        <p class="text-dark-400 text-sm mb-2">No analysis results.</p>
        <p class="text-dark-500 text-xs uppercase tracking-widest">RUN THE SCOUT TO BEGIN.</p>
      </div>

      <div id="resultsContent" class="hidden p-6">
      </div>
    </div>

    <button type="submit" form="truthForm" id="submitBtn"
      class="btn btn-primary btn-lg w-full"
      aria-label="Submit form to analyze company">
      <span id="submitBtnText">Run Analysis</span>
    </button>
  </section>
</div>

<div id="loadingSpinner" class="hidden mt-8 surface-elevated rounded-xl p-10 text-center result-card">
  <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-dark-700 border border-dark-600 mb-6 relative">
    <div class="absolute inset-0 rounded-full border-2 border-t-cyan-400 border-r-transparent border-b-transparent border-l-transparent animate-spin"></div>
    <svg class="w-10 h-10 text-cyan-400" fill="none" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" opacity="0.25" />
      <path fill="currentColor" d="M12 2a10 10 0 0110 10h-2a8 8 0 00-8-8V2z" opacity="0.75" />
    </svg>
  </div>
  <h3 class="text-2xl font-bold text-dark-100 mb-3 tracking-tight">ANALYZING COMPANY CLAIMS...</h3>
  <p class="text-dark-400 mb-5 text-sm">This may take 30-60 seconds</p>
  <div id="progressMessage" class="text-sm mb-6">
    <p class="text-cyan-400">üìä Extracting and analyzing claims...</p>
  </div>
  <div class="text-sm text-dark-400 space-y-2 max-w-md mx-auto">
    <div class="flex items-center gap-2 p-3 bg-dark-700/50 rounded-lg border border-dark-600">
      <span class="text-emerald-400">‚úì</span>
      <span>Fetching website content</span>
    </div>
    <div class="flex items-center gap-2 p-3 bg-dark-700/50 rounded-lg border border-dark-600">
      <span class="text-emerald-400">‚úì</span>
      <span>Extracting claims with AI</span>
    </div>
    <div class="flex items-center gap-2 p-3 bg-dark-700/50 rounded-lg border border-dark-600">
      <span class="text-emerald-400">‚úì</span>
      <span>Querying authoritative sources (NMLS, EDGAR, CFPB...)</span>
    </div>
    <div class="flex items-center gap-2 p-3 bg-dark-700/50 rounded-lg border border-dark-600">
      <span class="text-emerald-400">‚úì</span>
      <span>Reconciling discrepancies</span>
    </div>
    <div class="flex items-center gap-2 p-3 bg-dark-700 rounded-lg border border-cyan-500/30 shimmer-bg">
      <span class="text-cyan-400">‚è≥</span>
      <span>Generating truth card and memo...</span>
    </div>
  </div>

  <div class="mt-8 space-y-4 max-w-2xl mx-auto">
    <div class="skeleton skeleton-title"></div>
    <div class="flex gap-4">
      <div class="skeleton skeleton-circle"></div>
      <div class="flex-1 space-y-2">
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text" style="width: 80%;"></div>
      </div>
    </div>
    <div class="skeleton skeleton-text"></div>
    <div class="skeleton skeleton-text" style="width: 90%;"></div>
  </div>
</div>

{% if error %}
<div class="mt-8 p-6 rounded-xl surface-elevated border-l-4 border-red-500 result-card">
  <div class="flex items-start gap-4">
    <div class="text-3xl">‚ö†Ô∏è</div>
    <div class="flex-1">
      <h3 class="text-xl font-bold text-red-400 mb-3 uppercase tracking-wide">Analysis Failed</h3>
      <p class="text-dark-300 mb-5 whitespace-pre-line font-mono text-sm">{{ error }}</p>
      <button onclick="location.reload()"
        class="btn btn-secondary btn-md"
        aria-label="Reload page to try again">
        üîÑ Try Again
      </button>
    </div>
  </div>
</div>
{% endif %}

{% if result %}
{% set high_count = result.card.discrepancies | selectattr('severity','equalto','high') | list | length %}
{% set med_count = result.card.discrepancies | selectattr('severity','equalto','med') | list | length %}
{% set low_count = result.card.discrepancies | selectattr('severity','equalto','low') | list | length %}
<div class="mt-8 space-y-6">
  <div class="surface-elevated rounded-xl p-6 result-card">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
      <div>
        <div class="flex items-center gap-3 mb-2">
          <div class="text-caption text-cyan-400">TRUTH METER SUMMARY</div>
          {% if result.analysis_time %}
          <div class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded bg-emerald-500/20 border border-emerald-500/30 text-emerald-400 text-xs font-semibold">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            {{ result.analysis_time }}s
          </div>
          {% endif %}
        </div>
        <div class="text-3xl font-bold text-dark-100 mb-2 tracking-tight">{{ result.company }}</div>
        <div class="flex items-center gap-2 mb-2">
          <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded bg-dark-700 border border-dark-600 text-xs font-medium text-dark-300">
            <svg class="w-3 h-3 text-cyan-400" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            Gemini 3 Flash
          </span>
        </div>
        <p class="text-dark-500 text-xs">H = High, M = Medium, L = Low severity discrepancies</p>
      </div>

      <div class="flex gap-3">
        <div class="text-center px-5 py-3 bg-red-500/10 rounded-xl border border-red-500/30">
          <div class="text-caption text-red-400 mb-1">HIGH</div>
          <div class="text-3xl font-bold text-dark-100">{{ high_count }}</div>
        </div>
        <div class="text-center px-5 py-3 bg-amber-500/10 rounded-xl border border-amber-500/30">
          <div class="text-caption text-amber-400 mb-1">MED</div>
          <div class="text-3xl font-bold text-dark-100">{{ med_count }}</div>
        </div>
        <div class="text-center px-5 py-3 bg-emerald-500/10 rounded-xl border border-emerald-500/30">
          <div class="text-caption text-emerald-400 mb-1">LOW</div>
          <div class="text-3xl font-bold text-dark-100">{{ low_count }}</div>
        </div>
      </div>

      <div class="text-center lg:text-right px-5 py-3 bg-cyan-500/10 rounded-xl border border-cyan-500/30">
        <div class="text-caption text-cyan-400">OVERALL CONFIDENCE</div>
        <div class="text-4xl font-bold gradient-text my-1">{{ (result.card.overall_confidence*100)|round }}%</div>
        <div class="text-xs text-dark-500">{{ result.card.severity_summary }}</div>
      </div>
    </div>
  </div>

  <div class="grid lg:grid-cols-2 gap-6">
    <div class="surface-elevated rounded-xl p-6 result-card">
      <div class="flex items-center justify-between mb-5 pb-4 border-b border-dark-600">
        <div>
          <div class="text-caption text-cyan-400">{{ result.company }}</div>
          <div class="text-2xl font-bold text-dark-100">Truth Card</div>
        </div>
        <div class="text-right">
          <div class="text-xs text-dark-500">{{ result.card.severity_summary }}</div>
          <div class="text-sm font-semibold text-cyan-400">{{ (result.card.overall_confidence*100)|round }}% Conf</div>
        </div>
      </div>

      <div class="space-y-4" role="region" aria-label="Discrepancies">
        {% for d in result.card.discrepancies %}
        {% set severity_class = 'severity-' + d.severity %}
        <div class="p-5 rounded-xl {{ severity_class }}" role="article" aria-labelledby="discrepancy-{{ loop.index }}">
          {% set badge_bg = 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30' %}
          {% if d.severity == 'high' %}{% set badge_bg = 'bg-red-500/20 text-red-400 border-red-500/30' %}
          {% elif d.severity == 'med' %}{% set badge_bg = 'bg-amber-500/20 text-amber-400 border-amber-500/30' %}{% endif %}

          <div class="flex items-start gap-3 mb-4">
            <div class="text-2xl flex-shrink-0">{{ sev_emoji(d.severity) }}</div>
            <div class="flex-1 min-w-0">
              <div id="discrepancy-{{ loop.index }}" class="font-bold text-dark-100 text-base">{{ d.type }}</div>
              <div class="mt-2 flex items-center justify-between gap-3">
                <div class="text-xs text-dark-400">
                  <span class="font-semibold text-dark-300">Confidence:</span> {{ (d.confidence*100)|round }}%
                </div>
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold {{ badge_bg }} border capitalize">
                  {{ d.severity }}
                </span>
              </div>
              <div class="confidence-bar">
                <div class="confidence-fill" style="width: {{ (d.confidence*100)|round }}%;"></div>
              </div>
            </div>
          </div>

          {% if d.related_claim_texts %}
          <div class="mt-4 p-3 bg-dark-700/50 rounded-lg border-l-2 border-cyan-500">
            <div class="font-semibold text-dark-200 text-sm mb-2 flex items-center gap-2">
              üìã Related Claims
              <span class="text-xs bg-dark-600 text-dark-300 px-2 py-0.5 rounded">{{ d.related_claim_texts | length }}</span>
            </div>
            <ul class="pl-4 list-disc space-y-1 text-sm text-dark-400">
              {% for text in d.related_claim_texts %}
              <li>{{ text }}</li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}

          <div class="mt-4 p-3 bg-amber-500/5 rounded-lg border-l-2 border-amber-500">
            <div class="font-semibold text-dark-200 text-sm mb-1">üí° Why it matters:</div>
            <div class="text-sm text-dark-400">{{ d.why_it_matters }}</div>
          </div>

          <div class="mt-3 p-3 bg-cyan-500/5 rounded-lg border-l-2 border-cyan-500">
            <div class="font-semibold text-dark-200 text-sm mb-1">üîç Expected evidence:</div>
            <div class="text-sm text-dark-400">{{ d.expected_evidence }}</div>
          </div>

          <ul class="mt-3 space-y-2">
            {% for f in d.findings %}
            <li class="text-sm p-3 bg-dark-700/30 rounded-lg border border-dark-600">
              <span class="font-semibold text-dark-200">{{ f.key }}:</span>
              <span class="text-dark-400">{{ f.value }}</span>
              <span class="text-cyan-400 font-medium">({{ f.status }})</span>
              {% if f.citations and f.citations[0].url %}
              <a href="{{ f.citations[0].url }}" target="_blank" rel="noopener"
                class="ml-2 px-2 py-1 rounded bg-dark-600 text-cyan-400 hover:bg-dark-500 text-xs font-medium inline-flex items-center gap-1 transition-all">
                Source ‚Üó
              </a>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
        </div>
        {% else %}
        <div class="py-10 text-center">
          <div class="text-5xl mb-4">‚úÖ</div>
          <div class="text-lg font-bold text-dark-100 mb-2">No discrepancies flagged</div>
          <div class="text-sm text-dark-400">All claims appear consistent with authoritative sources</div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="space-y-6">
      <div class="surface-elevated rounded-xl p-6 result-card">
        <div class="flex items-center justify-between mb-4">
          <div class="text-lg font-bold text-dark-100">üìù Memo HTML</div>
          <button type="button"
            class="btn btn-secondary btn-sm"
            data-copy="memoHtml" onclick="copyText('memoHtml')" aria-label="Copy memo HTML to clipboard">
            üìã Copy
          </button>
        </div>
        <div id="memoHtml" class="prose prose-invert prose-sm max-w-none bg-dark-800 p-4 rounded-lg border border-dark-600 overflow-auto max-h-96">
          {{ result.memo_html | safe }}
        </div>
      </div>

      <div class="surface-elevated rounded-xl p-6 result-card">
        <details open>
          <summary class="flex items-center justify-between cursor-pointer list-none">
            <div class="text-lg font-bold text-dark-100">üíæ Raw JSON</div>
            <button type="button"
              class="btn btn-secondary btn-sm"
              data-copy="cardJson" onclick="copyText('cardJson'); event.stopPropagation();"
              aria-label="Copy JSON to clipboard">
              üìã Copy
            </button>
          </summary>
          <pre id="cardJson" class="text-xs bg-dark-800 rounded-lg p-4 overflow-auto mt-4 border border-dark-600 font-mono text-dark-300 max-h-96">{{ result.card_json }}</pre>
        </details>
      </div>
    </div>
  </div>

  <div class="text-center pt-4">
    <button onclick="location.reload()"
      class="btn btn-primary btn-lg px-12"
      aria-label="Reload page to run another analysis">
      üîÑ Run Another Analysis
    </button>
  </div>
</div>
{% endif %}

<script>
  let progressInterval;
  let progressSeconds = 0;

  function showLoadingState() {
    const formSection = document.querySelector('.grid.lg\\:grid-cols-12');
    if (document.getElementById('loadingSpinner').classList.contains('hidden')) {
      if (formSection) formSection.style.display = 'none';
      document.getElementById('loadingSpinner').classList.remove('hidden');
      document.getElementById('loadingSpinner').scrollIntoView({ behavior: 'smooth' });
      progressSeconds = 0;
      if (progressInterval) clearInterval(progressInterval);
      progressInterval = setInterval(updateProgressMessage, 5000);
    }
  }

  function normalizeUrl(value) {
    let trimmed = value.trim();
    if (!trimmed.startsWith('http://') && !trimmed.startsWith('https://')) {
      trimmed = 'https://' + trimmed;
    }
    if (trimmed.endsWith('/')) {
      trimmed = trimmed.slice(0, -1);
    }
    return trimmed;
  }

  function loadDemo(url, company, ticker) {
    document.querySelector('input[name="url"]').value = url;
    document.querySelector('input[name="company"]').value = company;
    document.querySelector('input[name="ticker"]').value = ticker || '';
    document.querySelector('select[name="jurisdiction"]').value = 'US';
    const renderJsInput = document.querySelector('input[name="render_js"]');
    if (renderJsInput) renderJsInput.checked = false;
    window.scrollTo({ top: 0, behavior: 'smooth' });
    updateTargetCount();
    showLoadingState();

    setTimeout(() => {
      document.getElementById('truthForm').requestSubmit();
    }, 500);
  }

  function validateURL(url) {
    try {
      const urlObj = new URL(url);
      if (!urlObj.protocol.match(/^https?:$/)) {
        return 'URL must start with http:// or https://';
      }
      if (!urlObj.hostname || urlObj.hostname.length < 1) {
        return 'Please enter a valid domain name';
      }
      return null;
    } catch (e) {
      return 'Please enter a valid URL (e.g., https://example.com)';
    }
  }

  function updateProgressMessage() {
    progressSeconds += 5;
    const messageEl = document.getElementById('progressMessage');
    const adapters = ['NMLS', 'FINTRAC', 'EDGAR', 'CFPB', 'Bank Partners', 'Trust Center', 'News', 'Press Metrics'];
    const adapterIndex = Math.min(Math.floor(progressSeconds / 10), adapters.length - 1);

    if (progressSeconds >= 90) {
      messageEl.innerHTML = '<p class="text-amber-400">‚è≥ Still analyzing... almost done! Finalizing results...</p>';
    } else if (progressSeconds >= 75) {
      messageEl.innerHTML = '<p class="text-cyan-400">üìã Reconciling claims and generating report...</p>';
    } else if (progressSeconds >= 60) {
      messageEl.innerHTML = '<p class="text-cyan-400">üîç Running checks on ' + adapters[Math.min(adapterIndex, 7)] + ' and compiling findings...</p>';
    } else if (progressSeconds >= 30) {
      messageEl.innerHTML = '<p class="text-cyan-400">üîå Querying: ' + adapters[adapterIndex] + '...</p>';
    } else {
      messageEl.innerHTML = '<p class="text-cyan-400">üìä Extracting and analyzing claims...</p>';
    }
  }

  function updateTargetCount() {
    const urlInput = document.getElementById('urlInput');
    const countEl = document.getElementById('targetCount');
    if (urlInput && urlInput.value.trim()) {
      countEl.textContent = '1 Targets';
    } else {
      countEl.textContent = '0 Targets';
    }
  }

  function handleSubmit(event) {
    const urlInput = document.getElementById('urlInput');
    const urlError = document.getElementById('urlError');
    const companyInput = document.getElementById('companyInput');
    const companyError = document.getElementById('companyError');
    const submitBtn = document.getElementById('submitBtn');
    const submitBtnText = document.getElementById('submitBtnText');
    const formSection = document.querySelector('.grid.lg\\:grid-cols-12');

    urlError.classList.add('hidden');
    companyError.classList.add('hidden');
    urlInput.setAttribute('aria-invalid', 'false');
    companyInput.setAttribute('aria-invalid', 'false');

    urlInput.classList.remove('border-red-500');
    companyInput.classList.remove('border-red-500');

    let hasError = false;

    if (!urlInput.value.trim()) {
      urlError.textContent = 'Please enter a company URL';
      urlError.classList.remove('hidden');
      urlInput.setAttribute('aria-invalid', 'true');
      urlInput.classList.add('border-red-500');
      urlInput.focus();
      hasError = true;
    } else {
      const validationError = validateURL(urlInput.value);
      if (validationError) {
        urlError.textContent = validationError;
        urlError.classList.remove('hidden');
        urlInput.setAttribute('aria-invalid', 'true');
        urlInput.classList.add('border-red-500');
        urlInput.focus();
        hasError = true;
      }
    }

    if (!companyInput.value.trim()) {
      companyError.textContent = 'Please enter a company name';
      companyError.classList.remove('hidden');
      companyInput.setAttribute('aria-invalid', 'true');
      companyInput.classList.add('border-red-500');
      if (!hasError) companyInput.focus();
      hasError = true;
    }

    if (hasError) {
      event.preventDefault();
      formSection.style.display = '';
      showToast('Please fix the errors in the form', 'error');
      return false;
    }

    submitBtn.disabled = true;
    submitBtnText.innerHTML = '<span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>Processing...';

    urlInput.value = normalizeUrl(urlInput.value);
    showLoadingState();

    return true;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const urlInput = document.getElementById('urlInput');
    if (urlInput) {
      urlInput.addEventListener('input', updateTargetCount);
    }
  });

  window.addEventListener('beforeunload', () => {
    if (progressInterval) {
      clearInterval(progressInterval);
    }
  });
</script>
{% endblock %}
